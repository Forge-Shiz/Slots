# Grease Burger Nginx Configuration
# Include this in your main nginx site config with:
#   include /var/www/html/slots/grease-burger/nginx-grease-burger.conf;

# ============================================
# SECURITY HEADERS (apply to all requests)
# ============================================

# Prevent clickjacking - only allow same-origin framing
add_header X-Frame-Options "SAMEORIGIN" always;

# Prevent MIME type sniffing
add_header X-Content-Type-Options "nosniff" always;

# XSS protection
add_header X-XSS-Protection "1; mode=block" always;

# Referrer policy
add_header Referrer-Policy "strict-origin-when-cross-origin" always;

# Content Security Policy
add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; media-src 'self'; font-src 'self'; connect-src 'self'; frame-ancestors 'self';" always;

# Hide server version info
server_tokens off;

# ============================================
# FILE ACCESS BLOCKING
# ============================================

# Block direct access to data directory
location /data/ {
    deny all;
    return 404;
}

# Block access to server.js
location = /server.js {
    deny all;
    return 404;
}

# Block access to node_modules
location /node_modules/ {
    deny all;
    return 404;
}

# Block access to package.json and package-lock.json
location ~* ^/package(-lock)?\.json$ {
    deny all;
    return 404;
}

# Block access to systemd service file
location ~* \.service$ {
    deny all;
    return 404;
}

# Block access to any .env files
location ~* \.env {
    deny all;
    return 404;
}

# Block access to any hidden files (dotfiles)
location ~ /\. {
    deny all;
    return 404;
}

# Block access to any .conf files
location ~* \.conf$ {
    deny all;
    return 404;
}

# Block access to any log files
location ~* \.log$ {
    deny all;
    return 404;
}

# ============================================
# API PROXY
# ============================================

# Proxy API requests to Node.js server
location /api/ {
    # Apply rate limiting (uncomment after adding zone to http block)
    # limit_req zone=grease_api burst=20 nodelay;

    proxy_pass http://localhost:3777/;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # Limit request body size
    client_max_body_size 10k;

    # Timeouts
    proxy_connect_timeout 10s;
    proxy_send_timeout 10s;
    proxy_read_timeout 10s;
}

# ============================================
# GENERAL SETTINGS
# ============================================

# Disable directory listing
autoindex off;
