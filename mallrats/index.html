<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>MALL RATS</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Bangers&family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;overflow:hidden;background:#1a0a2e;font-family:'Bangers',cursive}
#game-container{position:relative;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;background:url('assets/bck2.webp') center/cover no-repeat}

/* LOADING SCREEN */
#loading-screen{position:absolute;inset:0;background:linear-gradient(135deg,#1a0a2e 0%,#0d0518 50%,#1a0a2e 100%);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:1000;transition:opacity 0.5s}
#loading-screen.hidden{opacity:0;pointer-events:none}
#loading-title{
  font-size:clamp(32px,8vw,64px);
  font-family:'Bangers',cursive;
  color:#00CED1;
  text-shadow:4px 4px 0 #FF1493,-2px -2px 0 #9400D3,0 0 20px #00CED1,0 0 40px #FF1493;
  letter-spacing:8px;
  margin-bottom:20px;
  animation:title-bounce 1s ease-in-out infinite;
}
@keyframes title-bounce{
  0%,100%{transform:scale(1) rotate(-2deg)}
  50%{transform:scale(1.05) rotate(2deg)}
}
#loading-text{color:#FF1493;font-size:clamp(14px,3vw,20px);font-family:'Press Start 2P',monospace;text-shadow:0 0 10px #FF1493}
#loading-spinner{width:50px;height:50px;border:4px solid rgba(0,206,209,.3);border-top:4px solid #FF1493;border-radius:50%;animation:spin-loader .6s linear infinite;margin-top:20px}
@keyframes spin-loader{to{transform:rotate(360deg)}}

/* TOP BAR - Chrome/metallic 90s style */
#top-bar{
  position:absolute;top:10px;left:50%;transform:translateX(-50%);
  display:flex;gap:25px;
  background:linear-gradient(180deg,#c0c0c0 0%,#808080 50%,#606060 100%);
  padding:12px 30px;border-radius:8px;
  border:3px solid #9400D3;
  box-shadow:0 0 20px rgba(148,0,211,.5),inset 0 2px 0 #fff,inset 0 -2px 0 #404040;
}
.stat{display:flex;flex-direction:column;align-items:center}
.stat-label{font-size:clamp(10px,2vw,14px);color:#1a0a2e;text-transform:uppercase;letter-spacing:1px;font-weight:bold}
.stat-value{font-size:clamp(18px,3.5vw,26px);font-family:'Bangers',cursive;color:#FF1493;text-shadow:2px 2px 0 #000,0 0 10px rgba(255,20,147,.5);letter-spacing:2px}

/* SLOT FRAME - Neon mall arcade style */
#slot-area{
  position:relative;
  width:min(85vw,600px);
  aspect-ratio:5/6;
  max-height:80vh;
}
#reels-window{
  position:absolute;inset:0;overflow:hidden;border-radius:16px;
  background:linear-gradient(180deg,rgba(26,10,46,.95) 0%,rgba(13,5,24,.98) 100%);
  border:5px solid transparent;
  background-clip:padding-box;
  box-shadow:
    0 0 15px #00CED1,
    0 0 30px rgba(0,206,209,.5),
    0 0 60px rgba(148,0,211,.3),
    inset 0 0 30px rgba(255,20,147,.1);
}
#reels-window::before{
  content:'';position:absolute;inset:-5px;border-radius:20px;padding:5px;
  background:linear-gradient(45deg,#00CED1,#FF1493,#9400D3,#00CED1);
  background-size:400% 400%;
  animation:neon-shift 4s linear infinite;
  -webkit-mask:linear-gradient(#fff 0 0) content-box,linear-gradient(#fff 0 0);
  mask:linear-gradient(#fff 0 0) content-box,linear-gradient(#fff 0 0);
  -webkit-mask-composite:xor;mask-composite:exclude;
  pointer-events:none;z-index:20;
}
@keyframes neon-shift{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}

#reels-container{display:flex;width:100%;height:100%;gap:3px;padding:4px;position:relative;z-index:5}
.reel-col{flex:1;position:relative;overflow:hidden;border-radius:6px;background:rgba(0,0,0,0.2)}
.reel-strip{display:flex;flex-direction:column;position:absolute;width:100%;left:0;top:0}
.sym-cell{
  width:100%;
  background-size:85% 85%;
  background-repeat:no-repeat;
  background-position:center;
  background-color:rgba(0,206,209,.02);
  border-radius:4px;
  border:1px solid rgba(148,0,211,.1);
  flex-shrink:0;
  box-sizing:border-box;
  position:relative;
}

/* Winner animation - JAZZ CUP GLOW (teal/purple) */
.sym-cell.winner{
  animation:pulse-win .4s ease-in-out infinite alternate;
  box-shadow:inset 0 0 20px rgba(0,206,209,0.5),0 0 15px #00CED1,0 0 30px rgba(148,0,211,0.4);
  border-color:#00CED1 !important;
  z-index:10;
}
@keyframes pulse-win{
  from{transform:scale(1);filter:brightness(1.1) drop-shadow(0 0 5px #00CED1)}
  to{transform:scale(1.06);filter:brightness(1.4) drop-shadow(0 0 15px #00CED1) drop-shadow(0 0 20px #9400D3)}
}

/* Scatter win - gold mall map glow */
.sym-cell.scatter-win{
  animation:scatter-win-pulse .45s ease-in-out infinite alternate;
  box-shadow:inset 0 0 20px rgba(255,215,0,0.6),0 0 20px rgba(255,215,0,0.8),0 0 35px rgba(255,215,0,0.5);
  border-color:#FFD700 !important;
}
@keyframes scatter-win-pulse{
  from{transform:scale(1);filter:brightness(1.2) drop-shadow(0 0 10px rgba(255,215,0,0.7))}
  to{transform:scale(1.1);filter:brightness(1.6) drop-shadow(0 0 20px rgba(255,215,0,0.9))}
}

/* WILD SYMBOL - Cool S with rad glow */
.sym-cell.wild{
  animation:wild-pulse 2s ease-in-out infinite;
  position:relative;
}
.sym-cell.wild::before{
  content:'WILD';
  position:absolute;
  bottom:2px;
  left:50%;
  transform:translateX(-50%);
  font-size:9px;
  font-family:'Press Start 2P',monospace;
  color:#00CED1;
  text-shadow:0 0 4px #00CED1,0 0 8px #00CED1,0 1px 2px rgba(0,0,0,0.9);
  z-index:5;
  pointer-events:none;
}
@keyframes wild-pulse{
  0%,100%{filter:brightness(1.05) drop-shadow(0 0 5px rgba(0,206,209,0.4))}
  50%{filter:brightness(1.25) drop-shadow(0 0 12px rgba(0,206,209,0.7))}
}

/* SCATTER SYMBOL - Mall Map */
.sym-cell.scatter{
  animation:scatter-glow 2.5s ease-in-out infinite;
}
@keyframes scatter-glow{
  0%,100%{filter:brightness(1.1) drop-shadow(0 0 4px rgba(255,215,0,0.4))}
  50%{filter:brightness(1.3) drop-shadow(0 0 10px rgba(255,215,0,0.6))}
}

/* HIGH PAY symbols subtle glow */
.sym-cell.high-pay{
  animation:highpay-glow 3s ease-in-out infinite;
}
@keyframes highpay-glow{
  0%,100%{filter:brightness(1.05)}
  50%{filter:brightness(1.2) drop-shadow(0 0 6px rgba(148,0,211,0.4))}
}

/* === SPINNING STATE === */
.reel-col.spinning::before{
  content:'';position:absolute;inset:0;z-index:10;pointer-events:none;
  background:repeating-linear-gradient(0deg,transparent 0px,transparent 3px,rgba(0,0,0,0.1) 3px,rgba(0,0,0,0.1) 6px);
}
.reel-col.spinning .sym-cell{
  filter:blur(2px) brightness(1.1);
}
.reel-col.spinning .reel-strip{
  animation:reel-spin 0.06s linear infinite;
}
@keyframes reel-spin{
  0%{transform:translateY(0)}
  100%{transform:translateY(var(--cell-height))}
}

/* === STOPPING STATE === */
.reel-col.stopping .reel-strip{
  animation:none;
  transition:transform 0.12s ease-out;
  transform:translateY(0);
}
.reel-col.stopping .sym-cell{
  filter:none;
  animation:land-bounce 0.18s ease-out;
}
@keyframes land-bounce{
  0%{transform:translateY(-8px);filter:brightness(1.4) drop-shadow(-3px 0 0 #FF1493) drop-shadow(3px 0 0 #00CED1)}
  50%{transform:translateY(3px)}
  100%{transform:translateY(0);filter:none}
}

/* CONTROLS - Arcade button style */
#controls{
  position:absolute;bottom:15px;left:50%;transform:translateX(-50%);
  display:flex;align-items:center;gap:12px;
  background:linear-gradient(180deg,#404040 0%,#202020 100%);
  padding:12px 20px;border-radius:50px;
  border:3px solid #9400D3;
  box-shadow:0 0 20px rgba(148,0,211,.4),inset 0 2px 0 #606060;
}
.ctrl-btn{
  background:linear-gradient(180deg,#606060 0%,#303030 100%);
  border:2px solid #00CED1;
  color:#00CED1;
  padding:8px 14px;
  border-radius:6px;
  font-family:'Bangers',cursive;
  font-size:clamp(14px,2.5vw,18px);
  cursor:pointer;
  transition:all .15s;
  text-shadow:0 0 5px #00CED1;
  letter-spacing:1px;
}
.ctrl-btn:hover{
  background:linear-gradient(180deg,#00CED1 0%,#008B8B 100%);
  color:#1a0a2e;
  box-shadow:0 0 15px rgba(0,206,209,.6);
  text-shadow:none;
}
.ctrl-btn:disabled{opacity:.4;cursor:default}

#spin-btn{
  width:clamp(75px,16vw,110px);
  height:clamp(75px,16vw,110px);
  border-radius:50%;
  background:radial-gradient(circle at 35% 30%,#FF1493,#C71585 60%,#8B008B);
  border:4px solid #00CED1;
  color:#fff;
  font-size:clamp(14px,3vw,20px);
  font-family:'Bangers',cursive;
  cursor:pointer;
  box-shadow:0 6px 25px rgba(255,20,147,.5),inset 0 2px 10px rgba(255,255,255,.3);
  transition:transform .1s,box-shadow .1s;
  text-shadow:2px 2px 0 #000;
  letter-spacing:2px;
}
#spin-btn:hover{box-shadow:0 6px 35px rgba(255,20,147,.7),inset 0 2px 10px rgba(255,255,255,.3)}
#spin-btn:active{transform:scale(.95)}
#spin-btn:disabled{opacity:.5;cursor:default;transform:none}

#bet-display{display:flex;flex-direction:column;align-items:center}
#bet-display span{font-size:clamp(10px,2vw,12px);color:#00CED1;text-transform:uppercase}
#bet-display strong{font-size:clamp(16px,3vw,22px);color:#FF1493;font-family:'Bangers',cursive;text-shadow:2px 2px 0 #000;letter-spacing:2px}

/* WIN DISPLAY */
#win-display{
  position:absolute;
  top:42%;left:50%;
  transform:translate(-50%,-50%);
  font-size:clamp(22px,5vw,34px);
  font-family:'Bangers',cursive;
  color:#FFD700;
  text-shadow:3px 3px 0 #000,0 0 15px #FFD700,0 0 30px #FF1493;
  opacity:0;
  pointer-events:none;
  z-index:50;
  background:rgba(26,10,46,0.9);
  padding:10px 20px;
  border-radius:10px;
  border:3px solid #FF1493;
  letter-spacing:2px;
}
#win-display.show{animation:win-pop 1.3s ease-out forwards}
@keyframes win-pop{
  0%{opacity:0;transform:translate(-50%,-50%) scale(0.5) rotate(-5deg)}
  20%{opacity:1;transform:translate(-50%,-50%) scale(1.15) rotate(3deg)}
  40%{transform:translate(-50%,-50%) scale(0.95) rotate(-2deg)}
  60%{transform:translate(-50%,-50%) scale(1.05) rotate(1deg)}
  80%{opacity:1}
  100%{opacity:0;transform:translate(-50%,-50%) scale(1) rotate(0deg)}
}

/* WIN LINES - JAZZ CUP PATTERN SEGMENTS */
#win-lines{
  position:absolute;
  inset:4px;
  pointer-events:none;
  z-index:15;
  overflow:visible;
}

/* Each segment is a rotated div with jazz pattern background */
.jazz-segment{
  position:absolute;
  height:32px;
  background:url('assets/jazz_pattern.png') repeat-x left center;
  background-size:120px 100%;
  transform-origin:left center;
  border-radius:16px;
}

/* Connection dots at symbol centers */
.jazz-dot{
  position:absolute;
  width:38px;
  height:38px;
  background:url('assets/jazz_pattern.png') center center;
  background-size:80px 80px;
  border-radius:50%;
  transform:translate(-50%,-50%);
}

/* BIG WIN OVERLAY */
#bigwin-overlay{
  position:absolute;inset:0;
  background:rgba(0,0,0,0);
  display:none;align-items:center;justify-content:center;flex-direction:column;
  z-index:200;
  gap:20px;
}
#bigwin-overlay.active{display:flex;animation:bigwin-bg-fade 0.5s ease-out forwards}
@keyframes bigwin-bg-fade{from{background:rgba(0,0,0,0)}to{background:rgba(26,10,46,0.95)}}

#bigwin-title{
  font-size:clamp(36px,10vw,72px);
  font-family:'Bangers',cursive;
  color:#FFD700;
  text-shadow:5px 5px 0 #FF1493,-3px -3px 0 #00CED1,0 0 30px #FFD700,0 0 60px #FF1493;
  opacity:0;
  letter-spacing:8px;
  animation:none;
}
#bigwin-overlay.active #bigwin-title{
  animation:bigwin-title-show 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) 0.3s forwards;
}
@keyframes bigwin-title-show{
  0%{opacity:0;transform:scale(0.3) rotate(-10deg)}
  60%{transform:scale(1.2) rotate(5deg)}
  100%{opacity:1;transform:scale(1) rotate(0deg)}
}

#bigwin-amount{
  font-size:clamp(48px,14vw,100px);
  font-family:'Bangers',cursive;
  color:#00CED1;
  text-shadow:4px 4px 0 #000,0 0 20px #00CED1,0 0 40px #00CED1;
  opacity:0;
  letter-spacing:4px;
}
#bigwin-overlay.active #bigwin-amount{
  animation:bigwin-amt-show 0.6s ease-out 0.8s forwards,bigwin-pulse 0.5s ease-in-out 1.5s infinite alternate;
}
@keyframes bigwin-amt-show{
  from{opacity:0;transform:scale(0.2)}
  to{opacity:1;transform:scale(1)}
}
@keyframes bigwin-pulse{
  from{transform:scale(1);filter:brightness(1)}
  to{transform:scale(1.05);filter:brightness(1.2)}
}

/* GAMBLE FEATURE - Post-win buttons */
#gamble-prompt{
  position:absolute;
  bottom:100px;
  left:50%;
  transform:translateX(-50%);
  display:none;
  gap:15px;
  z-index:100;
  animation:gamble-prompt-in 0.3s ease-out;
}
#gamble-prompt.show{display:flex}
@keyframes gamble-prompt-in{
  from{opacity:0;transform:translateX(-50%) translateY(20px)}
  to{opacity:1;transform:translateX(-50%) translateY(0)}
}

.gamble-btn{
  padding:12px 24px;
  font-family:'Bangers',cursive;
  font-size:clamp(16px,3vw,22px);
  border-radius:10px;
  cursor:pointer;
  letter-spacing:2px;
  transition:all 0.15s;
  text-shadow:2px 2px 0 rgba(0,0,0,0.5);
}

#btn-double{
  background:linear-gradient(180deg,#FF1493 0%,#C71585 50%,#8B008B 100%);
  border:3px solid #FFD700;
  color:#fff;
  box-shadow:0 4px 15px rgba(255,20,147,0.5),inset 0 2px 0 rgba(255,255,255,0.3);
}
#btn-double:hover{
  transform:scale(1.05);
  box-shadow:0 6px 25px rgba(255,20,147,0.7),inset 0 2px 0 rgba(255,255,255,0.3);
}

#btn-collect{
  background:linear-gradient(180deg,#00CED1 0%,#008B8B 50%,#006666 100%);
  border:3px solid #FFD700;
  color:#fff;
  box-shadow:0 4px 15px rgba(0,206,209,0.5),inset 0 2px 0 rgba(255,255,255,0.3);
}
#btn-collect:hover{
  transform:scale(1.05);
  box-shadow:0 6px 25px rgba(0,206,209,0.7),inset 0 2px 0 rgba(255,255,255,0.3);
}

/* GAMBLE OVERLAY - 90s Character Duo Picker */
#gamble-overlay{
  position:absolute;
  inset:0;
  background:
    repeating-linear-gradient(90deg,rgba(0,0,0,0.1) 0px,rgba(0,0,0,0.1) 2px,transparent 2px,transparent 20px),
    linear-gradient(180deg,#1a0a2e 0%,#0d0518 100%);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:250;
}
#gamble-overlay.active{display:flex;animation:gamble-fade-in 0.3s ease-out}
@keyframes gamble-fade-in{from{opacity:0}to{opacity:1}}

/* Arcade Cabinet Frame */
#arcade-cabinet{
  position:relative;
  width:min(95vw,500px);
  padding:20px;
  background:linear-gradient(180deg,#4a4a4a 0%,#2a2a2a 50%,#1a1a1a 100%);
  border-radius:20px;
  border:4px solid #00CED1;
  box-shadow:
    0 0 30px rgba(0,206,209,0.4),
    inset 0 2px 0 #666,
    inset 0 -4px 0 #111;
}

#cabinet-screen{
  background:linear-gradient(180deg,#1a0a2e 0%,#0d0518 100%);
  border-radius:12px;
  padding:20px;
  border:3px solid #333;
  box-shadow:inset 0 0 30px rgba(0,0,0,0.8),0 0 20px rgba(148,0,211,0.3);
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:15px;
}

#gamble-title{
  font-family:'Bangers',cursive;
  font-size:clamp(24px,5vw,38px);
  color:#FFD700;
  text-shadow:3px 3px 0 #FF1493,-2px -2px 0 #00CED1,0 0 20px #FFD700;
  letter-spacing:3px;
}

#gamble-amount{
  font-family:'Bangers',cursive;
  font-size:clamp(28px,6vw,48px);
  color:#00CED1;
  text-shadow:2px 2px 0 #000,0 0 15px #00CED1;
  letter-spacing:2px;
}

#gamble-instruction{
  font-family:'Bangers',cursive;
  font-size:clamp(16px,3vw,24px);
  color:#FF1493;
  text-shadow:2px 2px 0 #000;
  letter-spacing:2px;
  animation:instruction-pulse 1s ease-in-out infinite alternate;
}
@keyframes instruction-pulse{
  from{opacity:0.7;transform:scale(1)}
  to{opacity:1;transform:scale(1.05)}
}
#gamble-instruction.hidden{display:none}

/* Character Duo Container */
#duo-container{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:15px;
  margin:10px 0;
}

#vs-text{
  font-family:'Bangers',cursive;
  font-size:clamp(28px,6vw,48px);
  color:#FFD700;
  text-shadow:3px 3px 0 #FF1493,0 0 15px #FFD700;
  animation:vs-bounce 0.8s ease-in-out infinite;
}
@keyframes vs-bounce{
  0%,100%{transform:scale(1) rotate(-5deg)}
  50%{transform:scale(1.1) rotate(5deg)}
}

.character-pick{
  display:flex;
  flex-direction:column;
  align-items:center;
  cursor:pointer;
  transition:all 0.2s;
  padding:10px;
  border-radius:15px;
  border:3px solid transparent;
  background:rgba(148,0,211,0.2);
}
.character-pick:hover{
  transform:scale(1.05);
  border-color:#00CED1;
  box-shadow:0 0 20px rgba(0,206,209,0.5);
}
.character-pick.disabled{
  pointer-events:none;
  opacity:0.7;
}

.character-pick img{
  width:clamp(100px,20vw,140px);
  height:clamp(100px,20vw,140px);
  object-fit:contain;
  border-radius:10px;
  background:rgba(0,0,0,0.3);
  border:2px solid #9400D3;
  transition:all 0.3s;
}

.char-name{
  font-family:'Bangers',cursive;
  font-size:clamp(14px,3vw,20px);
  color:#fff;
  text-shadow:2px 2px 0 #000;
  margin-top:8px;
  letter-spacing:1px;
}

/* Winner/Loser states */
.character-pick.winner{
  animation:winner-celebrate 0.5s ease-out forwards;
}
.character-pick.winner img{
  border-color:#00FF00;
  box-shadow:0 0 30px rgba(0,255,0,0.7),0 0 60px rgba(0,255,0,0.4);
}
.character-pick.winner .char-name{
  color:#00FF00;
}
@keyframes winner-celebrate{
  0%{transform:scale(1)}
  50%{transform:scale(1.15) rotate(5deg)}
  100%{transform:scale(1.1)}
}

.character-pick.loser{
  animation:loser-sad 0.5s ease-out forwards;
}
.character-pick.loser img{
  filter:grayscale(80%) brightness(0.6);
  border-color:#666;
}
.character-pick.loser .char-name{
  color:#888;
}
@keyframes loser-sad{
  0%{transform:scale(1)}
  50%{transform:scale(0.9) rotate(-5deg)}
  100%{transform:scale(0.85)}
}

/* Gamble result message */
#gamble-result{
  font-family:'Bangers',cursive;
  font-size:clamp(32px,7vw,56px);
  letter-spacing:4px;
  opacity:0;
  transition:opacity 0.3s;
}
#gamble-result.show{opacity:1}
#gamble-result.win{
  color:#00FF00;
  text-shadow:3px 3px 0 #000,0 0 20px #00FF00,0 0 40px #00FF00;
  animation:result-win 0.5s ease-out;
}
#gamble-result.lose{
  color:#FF0000;
  text-shadow:3px 3px 0 #000,0 0 20px #FF0000;
  animation:result-lose 0.5s ease-out;
}
@keyframes result-win{
  0%{transform:scale(0.5)}
  50%{transform:scale(1.2)}
  100%{transform:scale(1)}
}
@keyframes result-lose{
  0%,100%{transform:translateX(0)}
  20%,60%{transform:translateX(-10px)}
  40%,80%{transform:translateX(10px)}
}

/* Gamble continue/collect buttons */
#gamble-actions{
  display:none;
  gap:20px;
  margin-top:15px;
}
#gamble-actions.show{display:flex}

/* SOUND TOGGLE */
#sound-toggle{
  position:absolute;top:10px;right:10px;
  background:linear-gradient(180deg,#606060 0%,#303030 100%);
  border:2px solid #00CED1;
  color:#00CED1;
  width:44px;height:44px;border-radius:50%;
  cursor:pointer;font-size:20px;z-index:50;
  transition:all .15s;
}
#sound-toggle:hover{background:#00CED1;color:#1a0a2e}

/* Message popup */
#message{
  position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
  background:linear-gradient(180deg,rgba(26,10,46,.98),rgba(13,5,24,.98));
  border:3px solid #FF1493;
  padding:25px 45px;border-radius:15px;
  color:#fff;font-size:clamp(16px,4vw,24px);
  text-align:center;z-index:300;display:none;
  box-shadow:0 0 40px rgba(255,20,147,.6);
  font-family:'Bangers',cursive;
  letter-spacing:2px;
}
#message.show{display:block;animation:msg-in .3s ease-out}
@keyframes msg-in{from{opacity:0;transform:translate(-50%,-50%) scale(.7)}to{opacity:1;transform:translate(-50%,-50%) scale(1)}}

/* INFO BUTTON */
#info-btn{
  position:absolute;top:10px;left:10px;
  background:linear-gradient(180deg,#606060 0%,#303030 100%);
  border:2px solid #9400D3;
  color:#9400D3;
  width:44px;height:44px;border-radius:50%;
  cursor:pointer;font-size:22px;z-index:50;
  font-family:'Bangers',cursive;
  transition:all .15s;
}
#info-btn:hover{background:#9400D3;color:#fff}

/* INFO POPUP */
#info-popup{
  position:absolute;inset:0;
  background:rgba(13,5,24,0.98);
  display:none;
  flex-direction:column;
  align-items:center;
  padding:20px;
  z-index:400;
  overflow-y:auto;
}
#info-popup.active{display:flex}
#info-popup h2{
  font-family:'Bangers',cursive;
  font-size:clamp(28px,6vw,42px);
  color:#00CED1;
  text-shadow:3px 3px 0 #FF1493;
  margin-bottom:20px;
  letter-spacing:4px;
}
#info-close{
  position:absolute;top:15px;right:15px;
  background:none;border:none;
  color:#FF1493;font-size:36px;cursor:pointer;
}
#paytable{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
  gap:15px;
  max-width:800px;
  width:100%;
}
.pay-item{
  background:rgba(148,0,211,0.2);
  border:2px solid #9400D3;
  border-radius:10px;
  padding:12px;
  text-align:center;
}
.pay-item img{width:60px;height:60px;object-fit:contain}
.pay-item .name{color:#00CED1;font-family:'Bangers',cursive;font-size:16px;margin:8px 0 4px;letter-spacing:1px}
.pay-item .pays{color:#FF1493;font-size:12px;line-height:1.4}

/* Mobile responsive */
@media (max-width:768px) and (orientation:portrait){
  #top-bar{top:5px;padding:8px 18px;gap:15px}
  .stat-label{font-size:10px}
  .stat-value{font-size:18px}
  #slot-area{width:90vw;max-width:400px;aspect-ratio:5/6;max-height:70vh}
  #reels-window{border-width:4px}
  #controls{bottom:8px;padding:10px 15px;gap:8px}
  .ctrl-btn{padding:6px 10px;font-size:14px}
  #spin-btn{width:65px;height:65px;font-size:14px}
  #sound-toggle,#info-btn{width:38px;height:38px;font-size:18px}
  .sym-cell{background-size:80% 80%}
}
@media (max-width:400px){
  #slot-area{width:95vw;max-width:340px}
  #controls{padding:8px 10px;gap:6px}
  #spin-btn{width:58px;height:58px;font-size:12px}
}
</style>
</head>
<body>
<div id="game-container">
  <!-- Loading Screen -->
  <div id="loading-screen">
    <div id="loading-title">MALL RATS</div>
    <div id="loading-text">ENTERING THE MALL...</div>
    <div id="loading-spinner"></div>
  </div>

  <!-- Top Stats Bar -->
  <div id="top-bar">
    <div class="stat"><span class="stat-label">Balance</span><span class="stat-value" id="balance">$0.00</span></div>
    <div class="stat"><span class="stat-label">Win</span><span class="stat-value" id="win">$0.00</span></div>
  </div>

  <!-- Info Button -->
  <button id="info-btn">?</button>

  <!-- Slot Area -->
  <div id="slot-area">
    <div id="reels-window">
      <div id="reels-container"></div>
      <div id="win-lines"></div>
    </div>
  </div>

  <!-- Win Display -->
  <div id="win-display"></div>

  <!-- Controls -->
  <div id="controls">
    <button class="ctrl-btn" id="bet-down">-</button>
    <div id="bet-display"><span>BET</span><strong id="bet-val">$0.18</strong></div>
    <button class="ctrl-btn" id="bet-up">+</button>
    <button id="spin-btn">SPIN</button>
    <button class="ctrl-btn" id="auto-btn">AUTO</button>
  </div>

  <!-- Sound Toggle -->
  <button id="sound-toggle">ðŸ”Š</button>

  <!-- Big Win Overlay -->
  <div id="bigwin-overlay">
    <div id="bigwin-title">TOTALLY RADICAL!</div>
    <div id="bigwin-amount">$0.00</div>
  </div>

  <!-- Message Popup -->
  <div id="message"></div>

  <!-- Gamble Prompt (appears after win) -->
  <div id="gamble-prompt">
    <button class="gamble-btn" id="btn-double">DOUBLE UP?</button>
    <button class="gamble-btn" id="btn-collect">COLLECT</button>
  </div>

  <!-- Gamble Overlay (90s character duo picker) -->
  <div id="gamble-overlay">
    <div id="arcade-cabinet">
      <div id="cabinet-screen">
        <div id="gamble-title">DOUBLE OR NOTHING!</div>
        <div id="gamble-amount">$0.00</div>
        <div id="gamble-instruction">PICK YOUR WINNER!</div>

        <div id="duo-container">
          <div class="character-pick" id="char-left">
            <img src="" alt="Character 1">
            <div class="char-name"></div>
          </div>
          <div id="vs-text">VS</div>
          <div class="character-pick" id="char-right">
            <img src="" alt="Character 2">
            <div class="char-name"></div>
          </div>
        </div>

        <div id="gamble-result"></div>

        <div id="gamble-actions">
          <button class="gamble-btn" id="btn-double-again">DOUBLE AGAIN!</button>
          <button class="gamble-btn" id="btn-take-win">TAKE WINNINGS</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Info Popup -->
  <div id="info-popup">
    <button id="info-close">&times;</button>
    <h2>PAYTABLE</h2>
    <div id="paytable">
      <div class="pay-item">
        <img src="assets/sym_1_scatter_map.webp" alt="Mall Map">
        <div class="name">MALL MAP</div>
        <div class="pays">SCATTER<br>3+ = BONUS</div>
      </div>
      <div class="pay-item">
        <img src="assets/sym_2_wild_cools.webp" alt="Cool S">
        <div class="name">COOL S</div>
        <div class="pays">WILD<br>Subs All</div>
      </div>
      <div class="pay-item">
        <img src="assets/sym_3_high_tamagotchi.webp" alt="Tamagotchi">
        <div class="name">TAMAGOTCHI</div>
        <div class="pays">6x = 500<br>5x = 200<br>4x = 50</div>
      </div>
      <div class="pay-item">
        <img src="assets/sym_4_high_cd.webp" alt="Blink CD">
        <div class="name">BLINK CD</div>
        <div class="pays">6x = 400<br>5x = 150<br>4x = 40</div>
      </div>
      <div class="pay-item">
        <img src="assets/sym_5_mid_talkboy.webp" alt="Talk Boy">
        <div class="name">TALK BOY</div>
        <div class="pays">6x = 200<br>5x = 75<br>4x = 25</div>
      </div>
      <div class="pay-item">
        <img src="assets/sym_6_mid_cinnabon.webp" alt="Cinnabon">
        <div class="name">CINNABON</div>
        <div class="pays">6x = 150<br>5x = 50<br>4x = 20</div>
      </div>
      <div class="pay-item">
        <img src="assets/sym_7_low_rollerblades.webp" alt="Rollerblades">
        <div class="name">ROLLERBLADES</div>
        <div class="pays">6x = 100<br>5x = 30<br>4x = 15</div>
      </div>
      <div class="pay-item">
        <img src="assets/sym_8_low_beaniebaby.webp" alt="Beanie Baby">
        <div class="name">BEANIE BABY</div>
        <div class="pays">6x = 80<br>5x = 25<br>4x = 10</div>
      </div>
    </div>
  </div>
</div>

<script>
const API = '';
const TOKEN = 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzbG90b3BvbCIsImV4cCI6NDg2NzQ0NzYxNywibmJmIjoxNzA2NjQ3NjE3LCJ1aWQiOjN9.6g2Hig9ErG8IbvzkPppry5F8HJsMunZPwuQzmetGh4c';
const GAME_ALIAS = 'agt/fruitqueen';
const CID = 1, UID = 3;

// Symbol mapping - Fruit Queen symbols mapped to Mall Rats theme
// 1=Scatter, 2=Wild, 3-4=High, 5-6=Mid, 7-8=Low
const SYMBOLS = {
  1: 'sym_1_scatter_map.webp',      // Scatter - Mall Map
  2: 'sym_2_wild_cools.webp',       // Wild - Cool S
  3: 'sym_3_high_tamagotchi.webp',  // High - Tamagotchi
  4: 'sym_4_high_cd.webp',          // High - Blink CD
  5: 'sym_5_mid_talkboy.webp',      // Mid - Talk Boy
  6: 'sym_6_mid_cinnabon.webp',     // Mid - Cinnabon
  7: 'sym_7_low_rollerblades.webp', // Low - Rollerblades
  8: 'sym_8_low_beaniebaby.webp',   // Low - Beanie Baby
};

const SYMBOL_NAMES = {
  1: 'MALL MAP',
  2: 'COOL S',
  3: 'TAMAGOTCHI',
  4: 'BLINK CD',
  5: 'TALK BOY',
  6: 'CINNABON',
  7: 'ROLLERBLADES',
  8: 'BEANIE BABY'
};

// Special symbol IDs
const SYM_SCATTER = 1;
const SYM_WILD = 2;

// Grid configuration
const COLS = 5;
const ROWS = 6;
const PAYLINES = 18;
const REEL_BUFFER = 3; // Extra symbols for spin animation

let gid = null;
let balance = 0;
let totalBet = 0.18; // 18 paylines x 0.01
let currentScreen = null;
let betLevels = [0.18, 0.36, 0.90, 1.80, 3.60, 9.00, 18.00];
let betIdx = 0;
let spinning = false;
let autoSpin = false;
let soundEnabled = true;
let currentWin = 0; // Track current win for gamble feature
let inGamble = false; // Track if gamble is active

// DOM elements
let elReels, elBalance, elWin, elBet, elSpinBtn, elAutoBtn;
let elBigwin, elBigwinAmt, elBigwinTitle, elWinLines;
let elMessage, elWinDisplay, elLoading, elInfoPopup;
let elGamblePrompt, elGambleOverlay, elGambleAmount, elGambleResult;
let elGambleInstruction, elCharLeft, elCharRight, elGambleActions;

document.addEventListener('DOMContentLoaded', init);

async function init() {
  console.log('Initializing Mall Rats...');

  elReels = document.getElementById('reels-container');
  elBalance = document.getElementById('balance');
  elWin = document.getElementById('win');
  elBet = document.getElementById('bet-val');
  elSpinBtn = document.getElementById('spin-btn');
  elAutoBtn = document.getElementById('auto-btn');
  elBigwin = document.getElementById('bigwin-overlay');
  elBigwinAmt = document.getElementById('bigwin-amount');
  elBigwinTitle = document.getElementById('bigwin-title');
  elWinLines = document.getElementById('win-lines');
  elMessage = document.getElementById('message');
  elWinDisplay = document.getElementById('win-display');
  elLoading = document.getElementById('loading-screen');
  elInfoPopup = document.getElementById('info-popup');

  // Gamble elements
  elGamblePrompt = document.getElementById('gamble-prompt');
  elGambleOverlay = document.getElementById('gamble-overlay');
  elGambleAmount = document.getElementById('gamble-amount');
  elGambleResult = document.getElementById('gamble-result');
  elGambleInstruction = document.getElementById('gamble-instruction');
  elCharLeft = document.getElementById('char-left');
  elCharRight = document.getElementById('char-right');
  elGambleActions = document.getElementById('gamble-actions');

  buildReels();

  elSpinBtn.addEventListener('click', spin);
  elAutoBtn.addEventListener('click', toggleAuto);
  document.getElementById('bet-up').addEventListener('click', () => changeBet(1));
  document.getElementById('bet-down').addEventListener('click', () => changeBet(-1));
  document.getElementById('sound-toggle').addEventListener('click', toggleSound);
  document.getElementById('info-btn').addEventListener('click', () => elInfoPopup.classList.add('active'));
  document.getElementById('info-close').addEventListener('click', () => elInfoPopup.classList.remove('active'));

  // Gamble button listeners
  document.getElementById('btn-double').addEventListener('click', startGamble);
  document.getElementById('btn-collect').addEventListener('click', collectWin);
  document.getElementById('char-left').addEventListener('click', () => pickCharacter('left'));
  document.getElementById('char-right').addEventListener('click', () => pickCharacter('right'));
  document.getElementById('btn-double-again').addEventListener('click', resetGambleRound);
  document.getElementById('btn-take-win').addEventListener('click', collectGambleWin);

  try {
    console.log('Joining game...');
    const res = await apiPost('/game/new', { cid: CID, uid: UID, alias: GAME_ALIAS });
    console.log('Join response:', res);

    if (res.gid) {
      gid = res.gid;
      balance = res.wallet || 10000;

      elBet.textContent = formatBet(totalBet);

      if (res.game && res.game.scr) {
        const screen = decodeScreen(res.game.scr);
        displayScreen(screen);
      }

      updateUI();
      hideLoading();
      console.log('Game ready! GID:', gid);
    } else {
      showMessage('Failed to join game');
      console.error('No GID in response');
    }
  } catch (e) {
    console.error('Init error:', e);
    hideLoading();
    showMessage('Connection error: ' + e.message);
  }
}

function hideLoading() {
  elLoading.classList.add('hidden');
  setTimeout(() => elLoading.style.display = 'none', 500);
}

function buildReels() {
  elReels.innerHTML = '';
  for (let col = 0; col < COLS; col++) {
    const reelCol = document.createElement('div');
    reelCol.className = 'reel-col';
    reelCol.dataset.col = col;

    const reelStrip = document.createElement('div');
    reelStrip.className = 'reel-strip';

    // Create cells for visible rows + buffer for animation
    for (let row = 0; row < ROWS + REEL_BUFFER; row++) {
      const cell = document.createElement('div');
      cell.className = 'sym-cell';
      const symId = Math.floor(Math.random() * 8) + 1;
      cell.style.backgroundImage = `url('assets/${SYMBOLS[symId]}')`;
      reelStrip.appendChild(cell);
    }

    reelCol.appendChild(reelStrip);
    elReels.appendChild(reelCol);
  }

  requestAnimationFrame(setupReelSizes);
}

function setupReelSizes() {
  const cols = elReels.querySelectorAll('.reel-col');
  cols.forEach(col => {
    const colHeight = col.offsetHeight;
    const cellHeight = Math.floor(colHeight / ROWS);

    col.style.setProperty('--cell-height', `${cellHeight}px`);

    const cells = col.querySelectorAll('.sym-cell');
    cells.forEach(cell => {
      cell.style.height = `${cellHeight}px`;
    });
  });
}

window.addEventListener('resize', () => {
  if (!spinning) setupReelSizes();
});

function displayScreen(screen) {
  if (!screen) return;
  const cols = elReels.querySelectorAll('.reel-col');

  cols.forEach((col, c) => {
    const cells = col.querySelectorAll('.sym-cell');
    // screen[col][row] - set visible symbols
    for (let r = 0; r < ROWS && r < cells.length; r++) {
      const symId = screen[c] ? screen[c][r] : 1;
      cells[r].style.backgroundImage = `url('assets/${SYMBOLS[symId] || SYMBOLS[1]}')`;
      applySymbolClass(cells[r], symId);
    }
  });
}

function applySymbolClass(cell, symId) {
  cell.classList.remove('wild', 'scatter', 'high-pay');

  if (symId === SYM_WILD) {
    cell.classList.add('wild');
  } else if (symId === SYM_SCATTER) {
    cell.classList.add('scatter');
  } else if (symId === 3 || symId === 4) {
    cell.classList.add('high-pay');
  }
}

async function spin() {
  if (spinning || inGamble) return;
  if (balance < totalBet) {
    showMessage('Not enough balance, dude!');
    return;
  }

  const lineBet = totalBet / PAYLINES;

  spinning = true;
  elSpinBtn.disabled = true;
  elWin.textContent = '$0.00';
  clearWinHighlights();

  const cols = elReels.querySelectorAll('.reel-col');

  // Reset reels
  cols.forEach(col => {
    col.classList.remove('spinning', 'stopping');
  });

  // Randomize symbols for spin illusion
  cols.forEach(col => {
    const cells = col.querySelectorAll('.sym-cell');
    cells.forEach(cell => {
      const symId = Math.floor(Math.random() * 8) + 1;
      cell.style.backgroundImage = `url('assets/${SYMBOLS[symId]}')`;
      cell.classList.remove('wild', 'scatter', 'high-pay');
    });
  });

  // Start spinning
  cols.forEach(col => col.classList.add('spinning'));

  try {
    const res = await apiPost('/slot/spin', { gid, bet: lineBet });

    console.log('=== SPIN RESPONSE ===');
    console.log(JSON.stringify(res, null, 2));

    const rawScreen = res.game ? res.game.scr : res.scr;
    const screen = decodeScreen(rawScreen);
    currentScreen = screen;

    if (screen) {
      console.log('Screen:', screen.map((col, i) => `R${i+1}:[${col.join(',')}]`).join(' '));
    }

    // Stop reels sequentially
    for (let i = 0; i < cols.length; i++) {
      await delay(250 + i * 180);

      const col = cols[i];
      const cells = col.querySelectorAll('.sym-cell');

      // Set final symbols
      if (screen && screen[i]) {
        for (let r = 0; r < ROWS && r < cells.length; r++) {
          const symId = screen[i][r];
          cells[r].style.backgroundImage = `url('assets/${SYMBOLS[symId] || SYMBOLS[1]}')`;
          applySymbolClass(cells[r], symId);
          cells[r].dataset.symId = symId;
        }
      }

      col.classList.remove('spinning');
      col.classList.add('stopping');

      setTimeout(() => col.classList.remove('stopping'), 200);
    }

    await delay(300);

    balance = res.wallet !== undefined ? res.wallet : balance;
    updateUI();

    // Calculate total win from wins array (no explicit gain field in this API)
    let totalWin = 0;
    if (res.wins && res.wins.length > 0) {
      totalWin = res.wins.reduce((sum, w) => sum + (w.pay || 0), 0);
    }
    totalWin = res.game?.gain || res.gain || totalWin;

    // Process wins
    if (res.wins && res.wins.length > 0) {
      console.log('=== WINS ===');
      res.wins.forEach((w, i) => {
        const symName = SYMBOL_NAMES[w.sym] || `SYM${w.sym}`;
        console.log(`Win ${i+1}: Line ${w.li || 'SCATTER'}, ${w.num}x ${symName}, Pay $${w.pay?.toFixed(2) || 0}`);
      });

      await showLineWins(res.wins);
      highlightWins(res.wins, true);
    }

    if (totalWin > 0) {
      currentWin = totalWin;
      showWin(totalWin);
      if (totalWin >= totalBet * 15) {
        await showBigWin(totalWin);
      }

      // Show gamble prompt (unless auto-spinning)
      if (!autoSpin) {
        showGamblePrompt();
        spinning = false;
        return; // Wait for player to collect or gamble
      }
    }

    spinning = false;
    elSpinBtn.disabled = false;
    currentWin = 0;

    if (autoSpin) {
      setTimeout(spin, 1200);
    }

  } catch (e) {
    console.error('Spin error:', e);
    showMessage('Spin failed!');
    spinning = false;
    elSpinBtn.disabled = false;
    cols.forEach(col => col.classList.remove('spinning', 'stopping'));
  }
}

async function showLineWins(wins) {
  if (!wins || wins.length === 0) return;

  const cols = elReels.querySelectorAll('.reel-col');

  for (const win of wins) {
    if (!win.pay || win.pay <= 0) continue;

    clearWinHighlights();

    const positions = getWinPositions(win);
    if (positions.length === 0) continue;

    const isScatterWin = !win.li;

    // Highlight winning symbols
    positions.forEach(pos => {
      if (cols[pos.col]) {
        const cells = cols[pos.col].querySelectorAll('.sym-cell');
        if (cells[pos.row]) {
          cells[pos.row].classList.add('winner');
          if (isScatterWin) cells[pos.row].classList.add('scatter-win');
        }
      }
    });

    // Draw win line for payline wins
    if (!isScatterWin && positions.length >= 2) {
      drawWinLine(positions, win.li);
    }

    // Show win popup
    const symName = SYMBOL_NAMES[win.sym] || 'SYMBOL';
    elWinDisplay.textContent = `${symName} x${win.num} +$${win.pay.toFixed(2)}`;
    elWinDisplay.classList.add('show');

    await delay(600);
    elWinDisplay.classList.remove('show');
    await delay(100);
  }

  clearWinHighlights();
}

function getWinPositions(win) {
  const positions = [];

  if (!win || !win.pay || win.pay <= 0) return positions;

  // Use XY coordinates from API
  if (win.xy && win.xy.length > 0) {
    win.xy.forEach(coord => {
      // API sends [col, row] as 1-indexed, convert to 0-indexed
      const col = coord[0] - 1;
      const row = coord[1] - 1;
      if (col >= 0 && col < COLS && row >= 0 && row < ROWS) {
        positions.push({ col, row });
      }
    });
  }

  return positions;
}

function highlightWins(wins, drawLines) {
  if (!wins) return;

  const cols = elReels.querySelectorAll('.reel-col');

  wins.forEach(win => {
    if (!win.pay || win.pay <= 0) return;

    const positions = getWinPositions(win);
    const isScatterWin = !win.li;

    positions.forEach(pos => {
      if (cols[pos.col]) {
        const cells = cols[pos.col].querySelectorAll('.sym-cell');
        if (cells[pos.row]) {
          cells[pos.row].classList.add('winner');
          if (isScatterWin) cells[pos.row].classList.add('scatter-win');
        }
      }
    });

    if (drawLines && !isScatterWin && positions.length >= 2) {
      drawWinLine(positions, win.li);
    }
  });
}

function clearWinHighlights() {
  elReels.querySelectorAll('.sym-cell.winner').forEach(el => {
    el.classList.remove('winner', 'scatter-win');
  });
  clearWinLines();
}

function drawWinLine(positions, lineNum) {
  if (!lineNum || positions.length < 2) return;

  const cols = elReels.querySelectorAll('.reel-col');
  const reelsRect = elReels.parentElement.getBoundingClientRect();

  const points = positions.map(pos => {
    if (!cols[pos.col]) return null;
    const cells = cols[pos.col].querySelectorAll('.sym-cell');
    if (!cells[pos.row]) return null;

    const cellRect = cells[pos.row].getBoundingClientRect();
    return {
      x: cellRect.left + cellRect.width / 2 - reelsRect.left,
      y: cellRect.top + cellRect.height / 2 - reelsRect.top
    };
  }).filter(p => p !== null);

  if (points.length < 2) return;

  // Draw jazz pattern segments between each pair of points
  for (let i = 0; i < points.length - 1; i++) {
    const p1 = points[i];
    const p2 = points[i + 1];

    // Calculate segment length and angle
    const dx = p2.x - p1.x;
    const dy = p2.y - p1.y;
    const length = Math.sqrt(dx * dx + dy * dy);
    const angle = Math.atan2(dy, dx) * (180 / Math.PI);

    // Create segment div
    const segment = document.createElement('div');
    segment.className = 'jazz-segment';
    segment.style.left = p1.x + 'px';
    segment.style.top = p1.y + 'px';
    segment.style.width = (length + 10) + 'px'; // Slight overlap
    segment.style.transform = `translateY(-50%) rotate(${angle}deg)`;

    elWinLines.appendChild(segment);
  }

  // Add dots at each symbol position for smooth connections
  points.forEach(pt => {
    const dot = document.createElement('div');
    dot.className = 'jazz-dot';
    dot.style.left = pt.x + 'px';
    dot.style.top = pt.y + 'px';
    elWinLines.appendChild(dot);
  });
}

function clearWinLines() {
  elWinLines.innerHTML = '';
}

function showWin(amount) {
  elWin.textContent = '$' + amount.toFixed(2);
}

async function showBigWin(amount) {
  elBigwin.classList.remove('active');
  elBigwinAmt.textContent = '$0.00';

  // Set title based on win size
  if (amount >= totalBet * 50) {
    elBigwinTitle.textContent = 'MEGA RAD!';
  } else if (amount >= totalBet * 30) {
    elBigwinTitle.textContent = 'TOTALLY TUBULAR!';
  } else {
    elBigwinTitle.textContent = 'ALL THAT!';
  }

  void elBigwin.offsetWidth;
  elBigwin.classList.add('active');

  // Count up animation
  await delay(1400);

  const duration = Math.min(2000, 1000 + amount * 3);
  const startTime = Date.now();

  const countUp = () => {
    const elapsed = Date.now() - startTime;
    const progress = Math.min(elapsed / duration, 1);
    const eased = 1 - Math.pow(1 - progress, 3);
    const current = amount * eased;
    elBigwinAmt.textContent = '$' + current.toFixed(2);

    if (progress < 1) {
      requestAnimationFrame(countUp);
    }
  };
  countUp();

  await delay(duration + 2000);
  elBigwin.classList.remove('active');
}

function updateUI() {
  elBalance.textContent = '$' + balance.toFixed(2);
}

function changeBet(dir) {
  if (spinning) return;
  betIdx = Math.max(0, Math.min(betLevels.length - 1, betIdx + dir));
  totalBet = betLevels[betIdx];
  elBet.textContent = formatBet(totalBet);
}

function formatBet(val) {
  return '$' + val.toFixed(2);
}

function toggleAuto() {
  autoSpin = !autoSpin;
  elAutoBtn.style.background = autoSpin ? 'linear-gradient(180deg,#00CED1 0%,#008B8B 100%)' : '';
  elAutoBtn.style.color = autoSpin ? '#1a0a2e' : '';
  if (autoSpin && !spinning && !inGamble) spin();
}

function toggleSound() {
  soundEnabled = !soundEnabled;
  document.getElementById('sound-toggle').textContent = soundEnabled ? 'ðŸ”Š' : 'ðŸ”‡';
}

function showMessage(text) {
  elMessage.textContent = text;
  elMessage.classList.add('show');
  setTimeout(() => elMessage.classList.remove('show'), 2500);
}

async function apiPost(path, body) {
  const res = await fetch(API + path, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': TOKEN
    },
    body: JSON.stringify(body)
  });
  const data = await res.json();
  if (!res.ok) throw new Error(data.what || 'API Error');
  return data;
}

// Decode base64 encoded screen array from API
function decodeScreen(scrArray) {
  if (!scrArray || !Array.isArray(scrArray)) return null;

  return scrArray.map(b64str => {
    // Decode base64 to bytes
    const binary = atob(b64str);
    const bytes = [];
    for (let i = 0; i < binary.length; i++) {
      bytes.push(binary.charCodeAt(i));
    }
    return bytes;
  });
}

function delay(ms) { return new Promise(r => setTimeout(r, ms)); }

// ============================================
// GAMBLE / DOUBLE-UP FEATURE - 90s Character Duos
// ============================================

// Character duo definitions
const CHARACTER_DUOS = [
  { left: { img: 'wayne.webp', name: 'WAYNE' }, right: { img: 'garth.webp', name: 'GARTH' }, show: "Wayne's World" },
  { left: { img: 'bill.webp', name: 'BILL' }, right: { img: 'ted.webp', name: 'TED' }, show: "Bill & Ted" },
  { left: { img: 'harry.webp', name: 'HARRY' }, right: { img: 'lloyd.webp', name: 'LLOYD' }, show: "Dumb & Dumber" },
  { left: { img: 'ren.webp', name: 'REN' }, right: { img: 'stimpy.webp', name: 'STIMPY' }, show: "Ren & Stimpy" }
];

let currentDuo = null;
let selectedSide = null;

function showGamblePrompt() {
  elGamblePrompt.classList.add('show');
  elSpinBtn.disabled = true;
}

function hideGamblePrompt() {
  elGamblePrompt.classList.remove('show');
}

function collectWin() {
  hideGamblePrompt();
  currentWin = 0;
  elSpinBtn.disabled = false;
  clearWinHighlights();
}

function startGamble() {
  hideGamblePrompt();
  inGamble = true;

  // Reset state
  elGambleResult.classList.remove('show', 'win', 'lose');
  elGambleResult.textContent = '';
  elGambleActions.classList.remove('show');
  elGambleInstruction.classList.remove('hidden');
  elCharLeft.classList.remove('winner', 'loser', 'disabled');
  elCharRight.classList.remove('winner', 'loser', 'disabled');

  // Pick random duo
  currentDuo = CHARACTER_DUOS[Math.floor(Math.random() * CHARACTER_DUOS.length)];

  // Set up character images and names
  elCharLeft.querySelector('img').src = 'assets/' + currentDuo.left.img;
  elCharLeft.querySelector('.char-name').textContent = currentDuo.left.name;
  elCharRight.querySelector('img').src = 'assets/' + currentDuo.right.img;
  elCharRight.querySelector('.char-name').textContent = currentDuo.right.name;

  // Update amount display
  elGambleAmount.textContent = '$' + currentWin.toFixed(2);

  // Show overlay
  elGambleOverlay.classList.add('active');
}

async function pickCharacter(side) {
  // Disable both characters during API call
  elCharLeft.classList.add('disabled');
  elCharRight.classList.add('disabled');
  elGambleInstruction.classList.add('hidden');
  selectedSide = side;

  try {
    console.log('Picked:', side, '- Current win:', currentWin);

    // Call API
    const res = await apiPost('/slot/doubleup', { gid: gid, mult: 2 });
    console.log('Doubleup response:', res);

    // Determine result
    const gain = res.gain || res.game?.gain || 0;
    const won = gain > 0;

    // Determine winning side (based on API result, not player choice)
    const winningSide = won ? side : (side === 'left' ? 'right' : 'left');

    // Update balance from response
    if (res.wallet !== undefined) {
      balance = res.wallet;
      updateUI();
    }

    // Animate result
    await delay(500);

    if (winningSide === 'left') {
      elCharLeft.classList.add('winner');
      elCharRight.classList.add('loser');
    } else {
      elCharRight.classList.add('winner');
      elCharLeft.classList.add('loser');
    }

    await delay(600);

    if (won) {
      // Won! Double the amount
      currentWin = gain;
      elGambleAmount.textContent = '$' + currentWin.toFixed(2);
      elWin.textContent = '$' + currentWin.toFixed(2);

      elGambleResult.textContent = 'EXCELLENT!';
      elGambleResult.classList.add('show', 'win');

      // Show continue/collect buttons
      await delay(800);
      elGambleActions.classList.add('show');

    } else {
      // Lost!
      currentWin = 0;
      elWin.textContent = '$0.00';

      // Random 90s catchphrase for losing
      const losePhrases = ['BOGUS!', 'NOT!', 'AS IF!', 'PSYCH!', 'LAME!'];
      elGambleResult.textContent = losePhrases[Math.floor(Math.random() * losePhrases.length)];
      elGambleResult.classList.add('show', 'lose');

      // Auto close after delay
      await delay(2500);
      closeGamble();
    }

  } catch (e) {
    console.error('Gamble error:', e);
    showMessage('Gamble failed!');
    closeGamble();
  }
}

function resetGambleRound() {
  // Reset for another gamble round
  elGambleResult.classList.remove('show', 'win', 'lose');
  elGambleActions.classList.remove('show');
  elCharLeft.classList.remove('winner', 'loser', 'disabled');
  elCharRight.classList.remove('winner', 'loser', 'disabled');
  elGambleInstruction.classList.remove('hidden');

  // Pick a new random duo
  currentDuo = CHARACTER_DUOS[Math.floor(Math.random() * CHARACTER_DUOS.length)];
  elCharLeft.querySelector('img').src = 'assets/' + currentDuo.left.img;
  elCharLeft.querySelector('.char-name').textContent = currentDuo.left.name;
  elCharRight.querySelector('img').src = 'assets/' + currentDuo.right.img;
  elCharRight.querySelector('.char-name').textContent = currentDuo.right.name;

  // Update displayed amount
  elGambleAmount.textContent = '$' + currentWin.toFixed(2);
}

function collectGambleWin() {
  closeGamble();
}

function closeGamble() {
  elGambleOverlay.classList.remove('active');
  inGamble = false;
  currentWin = 0;
  elSpinBtn.disabled = false;
  clearWinHighlights();
}
</script>
</body>
</html>
